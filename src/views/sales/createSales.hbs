{{#extend 'stylesheets'}}
<!-- Datatables -->
    <link href="/vendors/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
    <link href="/vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
    <link href="/vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
    <link href="/vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
    <link href="/vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.0/jquery-confirm.min.css">

    <style>
        .quick-btn { background: #EEEEEE;
        box-shadow: 0 0 0 1px #F8F8F8 inset, 0 0 0 1px #CCCCCC;
        color: #444444;
        display: inline-block;
        height: 80px;
        margin: 10px;
        padding-top: 16px;
        text-align: center;
        text-decoration: none;
        width: 90px;
        position: relative;
        }
        .quick-btn span {
        display: block;
        }
        .quick-btn .label {
        position: absolute;
        right: -5px;
        top: -5px;
        }
        .quick-btn:hover {
        text-decoration: none;
        color: #fff;
        background-color: #4d7589;
        box-shadow: 3px 4px 1px #ccc;
        }
        .quick-btn.small {
        width: 40px;
        height: 30px;
        padding-top: 6px;
        }

        .btn-file {
    overflow: hidden;
    position: relative;
    vertical-align: middle;
    }      
.btn-file > input {
    position: absolute;
    top: 0;
    right: 0;
    margin: 0;
    opacity: 0;
    filter: alpha(opacity=0);
    transform: translate(-300px, 0) scale(4);
    font-size: 23px;
    direction: ltr;
    cursor: pointer;
    }
    .fileinput {
    margin-bottom: 9px;
    display: inline-block;
    }
    .fileinput .uneditable-input {
    display: inline-block;
    margin-bottom: 0px;
    vertical-align: middle;
    cursor: text;
    }
    .fileinput i + .fileinput-filename,
    .fileinput .btn + .fileinput-filename {
    padding-left: 5px;
    }
    .fileinput.fileinput-exists .close {
    opacity: 1;
    color: #dee0e4;
    position: relative;
    top: 3px;
    margin-left: 5px;
    }
    .fileinput .thumbnail {
    overflow: hidden;
    display: inline-block;
    margin-bottom: 5px;
    vertical-align: middle;
    text-align: center;
    }
    .fileinput .thumbnail[data-trigger="fileinput"] {
    cursor: pointer;
    }
    .fileinput .thumbnail:before,
    .fileinput .thumbnail:after {
    content: " ";
    display: table;
    }
    .fileinput .thumbnail:after {
    clear: both;
    }
    .fileinput .thumbnail > img {
    max-height: 100%;
    display: block;
    }
    .fileinput .btn {
    vertical-align: middle;
    }
    .fileinput-exists .fileinput-new,
    .fileinput-new .fileinput-exists {
    display: none;
    }
    .fileinput-inline .fileinput-controls {
    display: inline;
    }
    .fileinput .uneditable-input {
    white-space: normal;
    }
    .fileinput-new .input-group .btn-file {
    border-radius: 0 3px 3px 0;
    }
    .fileinput-new .input-group .btn-file.btn-xs,
    .fileinput-new .input-group .btn-file.btn-sm {
    border-radius: 0 2px 2px 0;
    }
    .fileinput-new .input-group .btn-file.btn-lg {
    border-radius: 0 3px 3px 0;
    }
    .form-group.has-warning .fileinput .uneditable-input {
    color: #574802;
    border-color: #ffd78a;
    }
    .form-group.has-warning .fileinput .fileinput-preview {
    color: #574802;
    }
    .form-group.has-warning .fileinput .thumbnail {
    border-color: #ffd78a;
    }
    .form-group.has-error .fileinput .uneditable-input {
    color: #ac1818;
    border-color: #ffafbd;
    }
    .form-group.has-error .fileinput .fileinput-preview {
    color: #ac1818;
    }
    .form-group.has-error .fileinput .thumbnail {
    border-color: #ffafbd;
    }
    .form-group.has-success .fileinput .uneditable-input {
    color: #045702;
    border-color: #b4e8a8;
    }
    .form-group.has-success .fileinput .fileinput-preview {
    color: #045702;
    }
    .form-group.has-success .fileinput .thumbnail {
    border-color: #b4e8a8;
    }
    .input-group-addon:not(:first-child) {
    border-left: 0;
    }
    .fileinput .uneditable-input,
    .fileinput-new .input-group .btn-file {
    display: table-cell !important;
    }

    </style>

{{/extend}}


<div class="">
    
    <div class="text-center">
        <a class="quick-btn text-red" href="#" data-toggle="modal" data-target="#customer">
        <i class="fa fa-plus fa-2x"></i>
        <span>New Customer</span>
        </a>
    </div>

    <div class="row">

        <div class="col-md-12 col-sm-12 col-xs-12">
        <div class="x_panel">
            <div class="x_title">
            <h2>Form Wizards <small>Sessions</small></h2>
            <ul class="nav navbar-right panel_toolbox">
                <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                </li>
                <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
                <ul class="dropdown-menu" role="menu">
                    <li><a href="#">Settings 1</a>
                    </li>
                    <li><a href="#">Settings 2</a>
                    </li>
                </ul>
                </li>
                <li><a class="close-link"><i class="fa fa-close"></i></a>
                </li>
            </ul>
            <div class="clearfix"></div>
            </div>
            <div class="x_content">

            <form class="form-horizontal form-label-left" id="allSales">
            <!-- Smart Wizard -->
            <div id="wizard" class="form_wizard wizard_horizontal">
                <ul class="wizard_steps">
                <li>
                    <a href="#step-1">
                    <span class="step_no">1</span>
                    <span class="step_descr">
                        Step 1<br />
                        <small>Invoice Details</small>
                    </span>
                    </a>
                </li>
                <li>
                    <a href="#step-2">
                    <span class="step_no">2</span>
                    <span class="step_descr">
                        Step 2<br />
                        <small>Customer Details</small>
                    </span>
                    </a>
                </li>
                <li>
                    <a href="#step-3">
                    <span class="step_no">3</span>
                    <span class="step_descr">
                        Step 3<br />
                        <small>Product Details</small>
                    </span>
                    </a>
                </li>
                <li>
                    <a href="#step-4">
                    <span class="step_no">4</span>
                    <span class="step_descr">
                        Step 4<br />
                        <small>Sales Details</small>
                    </span>
                    </a>
                </li>
                </ul>
                    <div id="step-1">
                        <form class="form-horizontal form-label-left">
                            <div class="row form-group">
                                <div class="form-group">
                                <label class="control-label col-md-3 col-sm-3" for="first-name">Record Invoice Date:
                                </label>
                                <div class="col-md-6 col-sm-6">
                                    <input type="date" required="required" name="saleDate" id="saleDate" class="form-control col-md-7 col-xs-12">
                                </div>
                                </div>
                                <div class="form-group">
                                <label class="control-label col-md-3 col-sm-3" for="last-name">Date:
                                </label>
                                <div class="col-md-6 col-sm-6">
                                    <input type="text" name="invoiceDate" id="invoiceDate" class="form-control col-md-7 col-xs-12" disabled>
                                </div>
                                </div>
                                <div class="form-group">
                                <label for="middle-name" class="control-label col-md-3 col-sm-3">Invoice No:</label>
                                <div class="col-md-6 col-sm-6">
                                    <input class="form-control col-md-7 col-xs-12" type="text" id="invoiceNumber" name="invoiceNumber" disabled>
                                </div>
                                </div>
                                <div class="form-group">
                                <label class="control-label col-md-3 col-sm-3">WAYBILLNo:
                                </label>
                                <div class="col-md-6 col-sm-6">
                                    <input class="form-control col-md-7 col-xs-12" disabled type="text" id="waybillNumber" name="waybillNumber">
                                </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div id="step-2">
                        <form class="form-horizontal form-label-left">
                            <div class="row form-group">
                                <div class="form-group">
                                    <div class="col-md-6 col-md-offset-3">
                                        <select class="form-control" name="_customerId" id="_customerId" required>
                                            <option>Select Customer</option>
                                            {{#each customers}}
                                                <option value="{{_id}}">{{name}}</option>
                                            {{/each}}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div id="step-3">
                        <form class="form-horizontal form-label-left" id="saleProduct">
                            <div class="row form-group">
                                <div class="form-group">
                                <label for="middle-name" class="control-label col-md-3 col-sm-3">Pieces Available:</label>
                                <div class="col-md-6 col-sm-6">
                                    <select class="form-control" id="_productId" name="_productId" onchange="getPieces(this.value)" required>
                                        <option>Select Product</option>
                                        {{#each products}}
                                            <option value="{{_productId._id}}" data-productName="{{_productId.name}}">{{_productId.name}}</option>
                                        {{/each}}
                                    </select>
                                </div>
                                </div>
                                <div class="form-group">
                                <label for="middle-name" class="control-label col-md-3 col-sm-3">Pieces Available:</label>
                                <div class="col-md-6 col-sm-6">
                                    <input class="form-control col-md-7 col-xs-12" type="text" name="piecesAvai" id="piecesAvai" placeholder="Pieces Available" disabled>
                                </div>
                                </div>
                                <div class="form-group">
                                <label class="control-label col-md-3 col-sm-3">Enter Pieces:
                                </label>
                                <div class="col-md-6 col-sm-6">
                                    <input class="form-control col-md-7 col-xs-12" type="text" onchange="enterPieces(this.value)" name="piecesSold" id="piecesSold" placeholder="Enter Pieces">
                                </div>
                                </div>
                                <div class="form-group">
                                <label class="control-label col-md-3 col-sm-3">Product Price:
                                </label>
                                <div class="col-md-6 col-sm-6">
                                    <input class="form-control col-md-7 col-xs-12" type="text" name="getPrice" id="getPrice" placeholder="Product Price" disabled>
                                </div>
                                </div>
                                <div class="form-group">
                                <div class="getMsg col-md-6 col-md-offset-3">

                                </div>
                                </div>
                                <div class="form-group">
                                <label class="control-label col-md-3 col-sm-3">Enter Price:
                                </label>
                                <div class="col-md-6 col-sm-6">
                                    <input class="form-control col-md-7 col-xs-12" type="text" onchange="pricePay(this.value)" name="productPrice" id="productPrice" placeholder="Enter Price">
                                </div>
                                </div>
                                <div class="form-group">
                                <div class="col-md-6 col-md-offset-3 text-center">
                                    <button type="submit" class="btn btn-success">Submit</button>
                                </div>
                                </div>
                            </div>
                        </form>

                        <div class="row">
                            <div class="col-md-6 col-md-offset-3">
                                <div class="x_panel">
                                    <div class="x_title">
                                    <h2>Sales </h2>
                                    <ul class="nav navbar-right panel_toolbox">
                                        <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                                        </li>
                                        <li class="dropdown">
                                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
                                        <ul class="dropdown-menu" role="menu">
                                            <li><a href="#">Settings 1</a>
                                            </li>
                                            <li><a href="#">Settings 2</a>
                                            </li>
                                        </ul>
                                        </li>
                                        <li><a class="close-link"><i class="fa fa-close"></i></a>
                                        </li>
                                    </ul>
                                    <div class="clearfix"></div>
                                    </div>
                                    <div class="x_content">

                                    <table class="table">
                                        <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Product Name</th>
                                            <th>Pieces</th>
                                            <th>Unit Price</th>
                                            <th>Total</th>
                                            <th>Action</th>
                                        </tr>
                                        </thead>
                                        <tbody id="saleTable">

                                        </tbody>
                                    </table>

                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div id="step-4">
                        <form class="form-horizontal form-label-left">
                            <div class="row form-group">
                                <div class="form-group">
                                <label class="control-label col-md-3 col-sm-3" for="first-name">Sum Amount By Sales Price:
                                </label>
                                <div class="col-md-6 col-sm-6">
                                    <input type="text" required="required" class="form-control col-md-7 col-xs-12" placeholder="Sum" name="sumAmt" id="sumAmt" disabled>
                                </div>
                                </div>
                                <div class="form-group">
                                <label class="control-label col-md-3 col-sm-3" for="last-name">Discount Given To Customer:
                                </label>
                                <div class="col-md-6 col-sm-6">
                                    <input type="text" name="discount" onchange="getDiscount(this.value)" class="form-control col-md-7 col-xs-12" placeholder="Discount Given To Customer" id="discount">
                                </div>
                                </div>
                                <div class="form-group">
                                <label for="middle-name" class="control-label col-md-3 col-sm-3">%VAT:</label>
                                <div class="col-md-6 col-sm-6">
                                    <input class="form-control col-md-7 col-xs-12" type="text" name="vat" placeholder="VAT" id="vat">
                                </div>
                                </div>
                                <div class="form-group">
                                <label for="middle-name" class="control-label col-md-3 col-sm-3">Amount Due To Customer:</label>
                                <div class="col-md-6 col-sm-6">
                                    <input class="form-control col-md-7 col-xs-12" type="text" name="amtDueToCus" placeholder="Amount Due To Customer" id="amtDueToCus" disabled>
                                </div>
                                </div>
                                <div class="form-group">
                                <label for="middle-name" class="control-label col-md-3 col-sm-3">Amount Paid By Customer:</label>
                                <div class="col-md-6 col-sm-6">
                                    <input class="form-control col-md-7 col-xs-12" type="text" onchange="amountPaidByCus(this.value)" placeholder="Amount Paid By Customer" name="payByCus" id="payByCus">
                                </div>
                                </div>
                                <div class="form-group">
                                <label class="control-label col-md-3 col-sm-3">Balance Transaction:
                                </label>
                                <div class="col-md-6 col-sm-6">
                                    <input class="form-control col-md-7 col-xs-12" type="text" placeholder="Balance Transaction" name="totalPrice" id="totalPrice" disabled>
                                </div>
                                </div>
                            </div>
                        </form>
                    </div>
            <!-- End SmartWizard Content -->
            </div>
            </form>
        </div>
        </div>
    </div>
</div>

<!-- Small modal -->
<div class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-hidden="true" id="customer">
<div class="modal-dialog modal-sm" style="width: 400px;">
    <div class="modal-content">

        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span>
            </button>
            <h4 class="modal-title" id="myModalLabel2">Create Customer</h4>
        </div>
        <div class="modal-body">
            
            <div class="x_panel">
                
                <div class="x_content">
                <br />
                <form class="form-horizontal form-label-left" method="POST" action="/sales/create/customer">

                    <div class="form-group">
                    <label class="control-label col-md-3 col-sm-3 col-xs-12">Name</label>
                    <div class="col-md-9 col-sm-9 col-xs-12">
                        <input type="text" class="form-control" id="name" name="name" placeholder="Customer Name">
                    </div>
                    </div>
                    <div class="form-group">
                    <label class="control-label col-md-3 col-sm-3 col-xs-12">E-mail</label>
                    <div class="col-md-9 col-sm-9 col-xs-12">
                        <input type="email" class="form-control" id="email" name="email" placeholder="E-mail">
                    </div>
                    </div>
                    <div class="form-group">
                    <label class="control-label col-md-3 col-sm-3 col-xs-12">Phone</label>
                    <div class="col-md-9 col-sm-9 col-xs-12">
                        <input type="number" class="form-control" id="phone" name="phone" placeholder="Phone">
                    </div>
                    </div>
                    <div class="form-group">
                    <label class="control-label col-md-3 col-sm-3 col-xs-12">Address</label>
                    <div class="col-md-9 col-sm-9 col-xs-12">
                        <textarea class="form-control" name="address" id="address" rows="2" placeholder="Address"></textarea>
                    </div>
                    </div>
                    <div class="ln_solid"></div>
                    <div class="form-group">
                    <div class="col-md-9 col-sm-9 col-xs-12 col-md-offset-3">
                        <button type="submit" class="btn btn-success">Submit</button>
                    </div>
                    </div>

                </form>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<!-- /modals -->


<!-- Small modal -->
<div class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-hidden="true" id="updateSales">
<div class="modal-dialog modal-sm" style="width: 500px;">
    <div class="modal-content">

        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span>
            </button>
            <h4 class="modal-title" id="myModalLabel2">Update Purchased Sales</h4>
        </div>
        <div class="modal-body">
            
            <div class="x_panel">
                
                <div class="x_content">
                <br />
                    <form class="form-horizontal form-label-left saleProduct">
                        <div class="row form-group" id="editSaleProduct">
                            <div class="form-group">
                            <label for="middle-name" class="control-label col-md-3 col-sm-3">Pieces Available:</label>
                            <div class="col-md-6 col-sm-6">
                                <select class="form-control" name="_productId" onchange="egetPieces(this.value)" required>
                                    <option>Select Product</option>
                                    {{#each products}}
                                        <option value="{{_productId._id}}" data-productName="{{_productId.name}}">{{_productId.name}}</option>
                                    {{/each}}
                                </select>
                            </div>
                            </div>
                            <div class="form-group">
                            <label for="middle-name" class="control-label col-md-3 col-sm-3">Pieces Available:</label>
                            <div class="col-md-6 col-sm-6">
                                <input class="form-control col-md-7 col-xs-12" type="text" name="epiecesAvai" id="epiecesAvai" placeholder="Pieces Available" disabled>
                            </div>
                            </div>
                            <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3">Enter Pieces:
                            </label>
                            <div class="col-md-6 col-sm-6">
                                <input class="form-control col-md-7 col-xs-12" type="text" onchange="eenterPieces(this.value)" name="epiecesSold" id="epiecesSold" placeholder="Enter Pieces">
                            </div>
                            </div>
                            <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3">Product Price:
                            </label>
                            <div class="col-md-6 col-sm-6">
                                <input class="form-control col-md-7 col-xs-12" type="text" name="egetPrice" id="egetPrice" placeholder="Product Price" disabled>
                            </div>
                            </div>
                            <input type="hidden" name="_uproductId" value="" />
                            <div class="form-group">
                            <div class="egetMsg col-md-6 col-md-offset-3">

                            </div>
                            </div>
                            <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3">Enter Price:
                            </label>
                            <div class="col-md-6 col-sm-6">
                                <input class="form-control col-md-7 col-xs-12" type="text" onchange="epricePay(this.value)" name="eproductPrice" id="eproductPrice" placeholder="Enter Price">
                            </div>
                            </div>
                            <div class="form-group">
                            <div class="col-md-6 col-md-offset-3 text-center">
                                <button type="submit" class="btn btn-success">Submit</button>
                            </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<!-- /modals -->




{{#extend 'scripts'}}

    <!-- jQuery Smart Wizard -->
    <script src="/vendors/jQuery-Smart-Wizard/js/jquery.smartWizard.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.0/jquery-confirm.min.js"></script>


    <script>

        // get current date
        var invoiceDate = new Date().toDateString();
        $('#invoiceDate').val(invoiceDate);

        // generate invoice number
        function genInvoiceNumb() {
        var text = "";
        var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";

        for (var i = 0; i < 3; i++)
            text += possible.charAt(Math.floor(Math.random() * possible.length));

            return text;
        }
        var invoiceNumber = new Date().format('m-d-Y/h:i:s');
        $('#invoiceNumber').val('INVOP-'+invoiceNumber+'-'+genInvoiceNumb());


        // generate waybill number
        function genWayBilNumb() {
        var text = "";
        var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

        for (var i = 0; i < 11; i++)
            text += possible.charAt(Math.floor(Math.random() * possible.length));

        return text;
        }
        $('#waybillNumber').val(genWayBilNumb());


        function getPieces(id){
            var productId = id;

            $.ajax({
                type: 'POST',
                url: '/sales/get/pieces',
                dataType: 'json',
                data: { _productId: productId },
                success: function(data) {
                    $('#piecesAvai').empty();
                    $('#piecesAvai').val(data._productId.pieces);

                    $('#getPrice').empty();
                    $('#getPrice').val(data._productId.price);
                },
                error: function(jqXHR, textStatus, errorThrow) {
                    $.alert(errorThrow);
                }
            });
        }


        // for edit
        function egetPieces(id){
            var productId = id;

            console.log(productId);

            $.ajax({
                type: 'POST',
                url: '/sales/get/pieces',
                dataType: 'json',
                data: { _productId: productId },
                success: function(data) {
                    // for edit
                    $('#epiecesAvai').empty();
                    $('#epiecesAvai').val(data._productId.pieces);

                    $('#egetPrice').empty();
                    $('#egetPrice').val(data._productId.price);
                },
                error: function(jqXHR, textStatus, errorThrow) {
                    $.alert(errorThrow);
                }
            });
        }

        function enterPieces(pieces){

            var available = $('#piecesAvai').val();
            var piecesSold = pieces;
            var sub = (parseFloat(available) - parseFloat(piecesSold));

            $('#piecesAvai').val(sub);
        }

        // for edit
        function eenterPieces(pieces){
            var available = $('#epiecesAvai').val();
            var piecesSold = pieces;
            var sub = (parseFloat(available) - parseFloat(piecesSold));

            $('#epiecesAvai').val(sub);
        }


        function pricePay(price){
            var initPrice = price;
            var presentPrice = $('#getPrice').val();

            if(parseFloat(initPrice) < parseFloat(presentPrice)){
                var msg = '<div class="alert alert-danger alert-dismissible fade in" role="alert">'+
                            '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span>'+
                            '</button>'+
                            'You can\'t sell below ' + presentPrice+
                            '</div>';

                $('#productPrice').val(0);
            }

            $('.getMsg').append(msg);
            $('.getMsg').show().fadeOut( 10000 );
        }

        // for edit
        function epricePay(price){
            var initPrice = price;
            var presentPrice = $('#egetPrice').val();

            if(parseFloat(initPrice) < parseFloat(presentPrice)){
                var msg = '<div class="alert alert-danger alert-dismissible fade in" role="alert">'+
                            '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span>'+
                            '</button>'+
                            'You can\'t sell below ' + presentPrice+
                            '</div>';

                $('#eproductPrice').val(0);
            }

            $('.egetMsg').append(msg);
            $('.egetMsg').show().fadeOut( 10000 );
        }

/*
        $('#saleProduct').submit(function(e){
            e.preventDefault();

            var salesArray = [];

            var p = $(this).find(':selected').attr('data-productName');

            //var form_data = $(this).serialize(); //Encode form elements
            var form_data = $(this).serializeArray(); //Encode form elements
            form_data.push({name: 'productName', value: p});

            console.log(form_data);

            salesArray.push(form_data);
            $("#saleProduct")[0].reset();

            console.log(salesArray);


            var totalCal = [];
            salesArray.forEach(function(item, index, array){

                var cal = (item[1].value * item[2].value);
                
                totalCal.push(cal);
                console.log(cal);
                console.log(totalCal);
                //totalCal = (parseInt(totalCal) + parseInt(cal));


                var tr = '<tr>'+
                        '<td>'+(index+1)+'</td>'+
                        '<td>'+item[3].value+'</td>'+
                        '<td>'+item[1].value+'</td>'+
                        '<td>'+item[2].value+'</td>'+
                        '<td>'+cal+'</td>'+
                        '<td>'+
                            '<button type="button" productId="'+ item[0].value +'" pieces="'+ item[1].value +'" price="'+ item[2].value +'" data-target="#updateSales"  data-toggle="modal" value="'+ item[0].value +'" class="btn btn-success btn-sm">Edit</button>'+
                            '<button type="button" value="'+ item[0].value +'" onclick="deleteProduct(this.value)" class="btn btn-danger btn-sm">Delete</button>'
                            +'</td>'+
                    '</tr>'

                $('#saleTable').append(tr);
                $("#saleProduct")[0].reset();
                //$('#sumAmt').val(cal);
            })
            //console.log(totalCal);
            $('#sumAmt').val(totalCal);
        });*/

/*
        $('#saleProduct').submit(function(e){
            e.preventDefault();

            //var form_data = $(this).serialize(); //Encode form elements
            var form_data = $(this).serializeArray(); //Encode form elements

            salesArray.push(form_data);
            $("#saleProduct")[0].reset();

            console.log(salesArray);

            $.ajax({
                type: 'POST',
                url: '/sales/create/sale',
                dataType: 'json',
                data: form_data,
            }).done(function(data){

                console.log(data);
                console.log(data['_branchproductId.pieces']);

                var cal = (data['productPrice'] * data['piecesSold']);

                var tr = '<tr>'+
                        '<td>'+1+'</td>'+
                        '<td>'+data['_branchproductId._productId.name']+'</td>'+
                        '<td>'+data['piecesSold']+'</td>'+
                        '<td>'+data['productPrice']+'</td>'+
                        '<td>'+cal+'</td>'+
                        '<td>'+
                            '<button type="button" data-target="#updateSales" piecesAvai="'+data['_branchproductId.pieces']+'" productId="'+data['_branchproductId._productId']+'"  data-toggle="modal" value="'+ data['_id'] +'" class="btn btn-success btn-sm">Edit</button>'+
                            '<button type="button" value="'+ data['_id'] +'" onclick="deleteProduct(this.value)" class="btn btn-danger btn-sm">Delete</button>'
                            +'</td>'+
                    '</tr>'

                $('#saleTable').append(tr);
                $("#saleProduct")[0].reset();
                $('#sum').val(cal);

            });
        });
*/


        $('#updateSales').on('show.bs.modal', function (e) {

            var opener = e.relatedTarget; // Button that triggered the modal

            var productId = $(opener).attr('productId'); // Extract info from data-* attributes
            var pieces = $(opener).attr('pieces');
            var price = $(opener).attr('price'); 

            $('#editSaleProduct').find('[name="_uproductId"]').val(productId);
            $('#editSaleProduct').find('[name="pieces"]').val(pieces);
            $('#editSaleProduct').find('[name="price"]').val(price);
            
        });

        function deleteProduct(id){

            console.log(id);

            $.confirm({
                title: '<div style="color:red">Confirm!</div>',
                content: 'Are you sure you want to delete permanently?',
                buttons: {
                    confirm: function () {
                        delete_product(id);
                    },
                    cancel: function () {
                        $.alert('Canceled!');
                    },

                }
            });
        }

        var delete_product = function(id){

            $.ajax({
                type: "POST", // Post / Get method
                url: "/product/delete", //Where form data is sent on submission
                dataType:"text", // Data type, HTML, json etc.
                data:{ id:id}, //Form variables
                success:function(response){

                if (response === "success") {
                    $.confirm({
                        title: '<div style="color:green">Success</div>',
                        content: 'Product deleted Successfully',
                        /*buttons: {
                            ok: function () {
                            location.reload(true)
                            },
                        }*/
                    });
                }

                },
                error:function (xhr, ajaxOptions, thrownError){
                        $.alert('Could not delete');
                }
                });
        }


        function getDiscount(e){

            var sum = $('#sumAmt').val();
            var totalDiscount = (sum - e);
            $('#amtDueToCus').val(totalDiscount);
            $('#totalPrice').val(totalDiscount);
        }

        function amountPaidByCus(e){
            var amtDueToCus = $('#amtDueToCus').val();
            var totalDiscount = (e - amtDueToCus);
            $('#totalPrice').val(totalDiscount);
        }

    $(document).ready(function(){

        var salesArray = [];
        var salesObj = { };

        console.log(salesObj);

        //console.log(salesArray);

        {{!-- salesObj['_productId'] = $('#_productId').val();
        salesObj['piecesSold'] = $('#piecesSold').val();
        salesObj['productPrice'] = $('#productPrice').val(); --}}

        function checkexist(){
             alert($('#_productId').val());
            var inArray = -1;
            //salesObj['_productId'] = $('#_productId').val();
            for(var k = 0; k < salesArray.length; ++k ){
                if($('#_productId').val() === salesArray[k]._productId)
                    //alert($('#_productId').val())
                     //alert(salesArray[k]._productId)
                inArray = k;
                //console.log(k);
            }


            if(inArray > -1) {

                console.log('come when tru');

                //salesArray[inArray]. = $('#_productId').val();
               // salesArray[inArray].piecesSold = $('#piecesSold').val() + 
                //salesObj['productPrice'] = $('#productPrice').val();

                salesArray[inArray].piecesSold = parseFloat(salesArray[inArray].piecesSold) + parseFloat($('#piecesSold').val());
                salesArray[inArray].productTotalPrice = parseFloat(salesArray[inArray].piecesSold) * parseFloat(salesArray[inArray].productTotalPrice);

                console.log(salesArray, 'if inArray is tru');
                
                tableAppend();
                //break;

            } else {

                var salesObj = { };

                console.log(salesArray, 'when inArray is false');
                console.log('create new one');

                var p = $(this).find(':selected').attr('data-productName');

                console.log(p);

                salesObj['_productId'] = $('#_productId').val();
                salesObj['productName'] = p;
                salesObj['piecesSold'] = $('#piecesSold').val();
                salesObj['productPrice'] = $('#productPrice').val();
                salesObj['productTotalPrice'] = parseFloat($('#productPrice').val()) *  parseFloat(salesObj['piecesSold'])

                salesArray.push(salesObj);
                salesObj = { };

                tableAppend();

            }

        }

        $('#saleProduct').submit(function(e){

          e.preventDefault();

         

            if(salesArray.length > 0 ){
                console.log('enter');
                checkexist();

            }else{
                alert($('#_productId').val());
                console.log('create if zero');
                
                var p = $(this).find(':selected').attr('data-productName');

                salesObj['_productId'] = $('#_productId').val();
                salesObj['productName'] = p;
                salesObj['piecesSold'] = $('#piecesSold').val();
                salesObj['productPrice'] = $('#productPrice').val();
                salesObj['productTotalPrice'] = $('#productPrice').val() *  salesObj['piecesSold']
                salesArray.push(salesObj);
                salesObj = { };

                console.log(salesArray);

                $("#saleProduct")[0].reset();

                tableAppend();

            }

        });


        var totalCal = [];
        
        function tableAppend(){
             $('#saleTable').empty();
            for (var i = 0, I = salesArray.length; i < I; i++) {

                var cal = (salesArray[i].piecesSold * salesArray[i].productPrice);
                console.log(cal);
                totalCal.push(cal);


                var tr = '<tr>'+
                        '<td>'+ (1 + i) +'</td>'+
                        '<td>'+salesArray[i].productName+'</td>'+
                        '<td>'+salesArray[i].piecesSold+'</td>'+
                        '<td>'+salesArray[i].productPrice+'</td>'+
                        '<td>'+cal+'</td>'+
                        '<td>'+
                            '<button type="button" productId="'+ salesArray[i]._productId +'" pieces="'+ salesArray[i].piecesSold +'" price="'+ salesArray[i].productPrice +'" data-target="#updateSales"  data-toggle="modal" value="'+ salesArray[i]._productId +'" class="btn btn-success btn-sm">Edit</button>'+
                            '<button type="button" value="'+ salesArray[i]._productId +'" onclick="deleteProduct(this.value)" class="btn btn-danger btn-sm">Delete</button>'
                            +'</td>'+
                    '</tr>'

                $('#saleTable').append(tr);
                $("#saleProduct")[0].reset();

                sumTotalCal = 0;
                $.each(totalCal, function(){sumTotalCal+=parseFloat(this) || 0;});
                console.log(sumTotalCal);

                $('#sumAmt').val(sumTotalCal);
            }
        }


        $('#allSales').submit(function(e){
           e.preventDefault();

           var dis = $('#discount').val();
           var vat = $('#vat').val();
           var amtDueToCus = $('#amtDueToCus').val();
           var payByCus = $('#payByCus').val();
           var totalPrice = $('#totalPrice').val();

           var saleDate = $('#saleDate').val();
           var invoiceDate = $('#invoiceDate').val();
           var invoiceNumber = $('#invoiceNumber').val();
           var waybillNumber = $('#waybillNumber').val();

           var customerId = $('#_customerId').val();

           console.log(saleDate, invoiceDate, invoiceDate, invoiceNumber, waybillNumber, 'step1');
           console.log(customerId, 'step2');
           console.log(salesArray, 'step3');
           console.log(dis, vat, amtDueToCus, payByCus, totalPrice, 'step4');

           $.ajax({
               type: 'POST',
               url: '/sales/create/sale',
               dataType: 'json',
               data: {
                   salesArray: salesArray,
                   discount: dis,
                   vat: vat,
                   amtDueToCus: amtDueToCus,
                   payByCus: payByCus,
                   totalPrice: totalPrice,
                   saleDate: saleDate,
                   invoiceDate: invoiceDate,
                   invoiceNumber: invoiceNumber,
                   waybillNumber: waybillNumber,
                   customerId: customerId
               }
           }).done(function(data){
               console.log(data);
               $('#msgSale').htm('Yes');
           });
        })


    })



        /*
        $('#allSales').submit(function(e){
           e.preventDefault();

           console.log(e);

           var form_data = $(this).serializeArray(); //Encode form elements

           console.log(form_data);
        })*/



        
</script>

{{/extend}}